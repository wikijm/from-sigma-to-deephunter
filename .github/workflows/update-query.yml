name: Update query.json

on:
  schedule:
    - cron: '0 0 * * *' # Runs daily at midnight UTC
  workflow_dispatch: # Allows manual triggering of the workflow

permissions:
  contents: write
  pull-requests: write

jobs:
  update-query:
    # avoid overlapping runs
    concurrency:
      group: update-query-${{ github.ref }}
      cancel-in-progress: true

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ensure Git LFS installed & track query.json (if needed)
        run: |
          if ! command -v git-lfs >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y git-lfs
          fi
          git lfs install --local
          # add tracking only if not already tracked
          if ! git lfs track | grep -q 'query.json'; then
            git lfs track "query.json"
            git add .gitattributes
          fi
        shell: bash

      - name: Run the sigma-to-deephunter script
        run: python sigma-to-deephunter.py

      - name: Configure Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch origin/main and base workspace on it
        run: |
          git fetch origin main
          # Make sure local main matches origin/main
          git checkout -B main origin/main

      - name: Stage generated files and check for changes
        id: git-check
        run: |
          git add query.json .gitattributes || true
          if git diff --staged --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected."
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected, will create branch, push, and open PR."
          fi

      - name: Create branch, commit and push changes
        if: steps.git-check.outputs.changed == 'true'
        id: push-branch
        env:
          BRANCH_NAME: update-query/${{ github.run_number }}-${{ github.run_id }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          echo "Using branch name: $BRANCH_NAME"
          git checkout -b "$BRANCH_NAME"
          git commit -m "chore: update query.json (run #${{ github.run_number }})" || echo "Nothing to commit"
          # Push branch to origin
          git push --set-upstream origin "$BRANCH_NAME"

      - name: Create Pull Request
        if: steps.git-check.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          # Use the branch we pushed earlier
          head: update-query/${{ github.run_number }}-${{ github.run_id }}
          base: main
          title: update query.json (run #${{ github.run_number }})
          body: |
            This automated PR updates query.json (generated by sigma-to-deephunter.py).
            - Workflow run: ${{ github.run_id }}
            - Run number: ${{ github.run_number }}
          draft: false
          labels: automated, update-query
